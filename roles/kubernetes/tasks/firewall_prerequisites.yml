---
# Define common SSH vars to be used by all tasks
- name: Set SSH connection facts
  set_fact:
    ssh_connection_vars:
      ansible_ssh_private_key_file: "{{ kubernetes_deployment.ssh_key_path }}"
      ansible_user: "{{ kubernetes_deployment.default_ansible_user }}"
      ansible_sudo_pass: "{{ kubernetes_deployment.default_ansible_user }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Set environment variables
  set_fact:
    ansible_env:
      LC_ALL: C
      LANG: C
  when: kubernetes_deployment.enabled | default(false)

- name: Set initial environment variables
  raw: export LC_ALL=C && export LANG=C
  changed_when: false
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Install required locale packages
  raw: DEBIAN_FRONTEND=noninteractive apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y locales
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Generate C.UTF-8 locale
  raw: locale-gen C.UTF-8
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Set system-wide locale
  raw: update-locale LC_ALL=C.UTF-8 LANG=C.UTF-8
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Install UFW
  raw: DEBIAN_FRONTEND=noninteractive apt-get install -y ufw
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Allow Kubernetes API Server port
  raw: ufw allow 6443/tcp comment "Kubernetes API Server"
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Allow etcd ports
  raw: ufw allow {{ item }}/tcp comment "etcd"
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  loop:
    - 2379
    - 2380
  when: kubernetes_deployment.enabled | default(false)

- name: Allow Kubelet API port
  raw: ufw allow 10250/tcp comment "Kubelet API"
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Allow kube-scheduler port
  raw: ufw allow 10251/tcp comment "kube-scheduler health/metrics"
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Allow kube-controller-manager port
  raw: ufw allow 10252/tcp comment "kube-controller-manager health/metrics"
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Reload UFW
  raw: ufw reload
  delegate_to: "{{ groups['kube_control_plane'][0] }}"
  when: kubernetes_deployment.enabled | default(false) 