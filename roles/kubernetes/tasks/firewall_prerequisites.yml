---
# Define common SSH vars to be used by all tasks
- name: Set SSH connection facts
  set_fact:
    ssh_connection_vars:
      ansible_ssh_private_key_file: "{{ kubernetes_deployment.ssh_key_path }}"
      ansible_user: "{{ item.ansible_user | default(kubernetes_deployment.default_ansible_user) }}"
  loop: "{{ kubernetes_deployment.control_plane_nodes + kubernetes_deployment.worker_nodes | default([]) }}"
  when: kubernetes_deployment.enabled | default(false)

- name: Set initial environment variables
  shell: |
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
  become: true
  become_flags: -H -S
  delegate_to: "{{ item.ansible_host }}"
  loop: "{{ kubernetes_deployment.control_plane_nodes + kubernetes_deployment.worker_nodes | default([]) }}"
  when: kubernetes_deployment.enabled | default(false)
  vars:
    ansible_ssh_private_key_file: "{{ kubernetes_deployment.ssh_key_path }}"
    ansible_user: "{{ item.ansible_user | default(kubernetes_deployment.default_ansible_user) }}"
    ansible_become_pass: "{{ lookup('env', 'ANSIBLE_BECOME_PASS') | default(lookup('env', 'ANSIBLE_SUDO_PASS'), true) | default(kubernetes_deployment.ansible_sudo_pass, true) | default('') }}"
  environment:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8

- name: Install required packages
  apt:
    name: 
      - locales
      - ufw
    state: present
    update_cache: yes
  become: true
  become_flags: -H -S
  delegate_to: "{{ item.ansible_host }}"
  loop: "{{ kubernetes_deployment.control_plane_nodes + kubernetes_deployment.worker_nodes | default([]) }}"
  when: kubernetes_deployment.enabled | default(false)
  vars:
    ansible_ssh_private_key_file: "{{ kubernetes_deployment.ssh_key_path }}"
    ansible_user: "{{ item.ansible_user | default(kubernetes_deployment.default_ansible_user) }}"
    ansible_become_pass: "{{ lookup('env', 'ANSIBLE_BECOME_PASS') | default(lookup('env', 'ANSIBLE_SUDO_PASS'), true) | default(kubernetes_deployment.ansible_sudo_pass, true) | default('') }}"
  environment:
    DEBIAN_FRONTEND: noninteractive
    LC_ALL: C.UTF-8
    LANG: C.UTF-8

- name: Configure locales
  shell: |
    locale-gen C.UTF-8
    update-locale LC_ALL=C.UTF-8 LANG=C.UTF-8
  become: true
  become_flags: -H -S
  delegate_to: "{{ item.ansible_host }}"
  loop: "{{ kubernetes_deployment.control_plane_nodes + kubernetes_deployment.worker_nodes | default([]) }}"
  when: kubernetes_deployment.enabled | default(false)
  vars:
    ansible_ssh_private_key_file: "{{ kubernetes_deployment.ssh_key_path }}"
    ansible_user: "{{ item.ansible_user | default(kubernetes_deployment.default_ansible_user) }}"
    ansible_become_pass: "{{ lookup('env', 'ANSIBLE_BECOME_PASS') | default(lookup('env', 'ANSIBLE_SUDO_PASS'), true) | default(kubernetes_deployment.ansible_sudo_pass, true) | default('') }}"
  environment:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8

- name: Configure UFW rules for each host
  include_tasks: ufw_rules.yml
  loop: "{{ kubernetes_deployment.control_plane_nodes + kubernetes_deployment.worker_nodes | default([]) }}"
  loop_control:
    loop_var: current_host
  when: kubernetes_deployment.enabled | default(false)

- name: Enable UFW
  ufw:
    state: enabled
    logging: on
  become: true
  become_flags: -H -S
  delegate_to: "{{ item.ansible_host }}"
  loop: "{{ kubernetes_deployment.control_plane_nodes + kubernetes_deployment.worker_nodes | default([]) }}"
  when: kubernetes_deployment.enabled | default(false)
  vars:
    ansible_ssh_private_key_file: "{{ kubernetes_deployment.ssh_key_path }}"
    ansible_user: "{{ item.ansible_user | default(kubernetes_deployment.default_ansible_user) }}"
    ansible_become_pass: "{{ lookup('env', 'ANSIBLE_BECOME_PASS') | default(lookup('env', 'ANSIBLE_SUDO_PASS'), true) | default(kubernetes_deployment.ansible_sudo_pass, true) | default('') }}"
  environment:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8

- name: Reload UFW
  ufw:
    state: reloaded
  become: true
  become_flags: -H -S
  delegate_to: "{{ item.ansible_host }}"
  loop: "{{ kubernetes_deployment.control_plane_nodes + kubernetes_deployment.worker_nodes | default([]) }}"
  when: kubernetes_deployment.enabled | default(false)
  vars:
    ansible_ssh_private_key_file: "{{ kubernetes_deployment.ssh_key_path }}"
    ansible_user: "{{ item.ansible_user | default(kubernetes_deployment.default_ansible_user) }}"
    ansible_become_pass: "{{ lookup('env', 'ANSIBLE_BECOME_PASS') | default(lookup('env', 'ANSIBLE_SUDO_PASS'), true) | default(kubernetes_deployment.ansible_sudo_pass, true) | default('') }}"
  environment:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8 