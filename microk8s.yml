---
- name: Deploy MicroK8s Cluster Only
  hosts: localhost
  gather_facts: true
  become: true
  become_method: sudo
  vars_files:
    - user_input.yml
    - group_vars/all/vault.yml
  vars:
    inventory_dir: "{{ playbook_dir }}/inventory"
    microk8s_dir: "{{ playbook_dir }}/microk8s"

  pre_tasks:
    - name: Load and verify user_input.yml
      block:
        - name: Load user_input.yml content
          include_vars:
            file: user_input.yml
            name: user_input

        - name: Set global facts
          set_fact:
            microk8s_deployment: "{{ user_input.microk8s_deployment }}"
            kubernetes_deployment: "{{ user_input.kubernetes_deployment }}"
          when: user_input.microk8s_deployment is defined

        - name: Verify microk8s_deployment section exists
          fail:
            msg: "microk8s_deployment section not found in user_input.yml"
          when: user_input.microk8s_deployment is not defined

        - name: Display loaded configuration
          debug:
            msg: |
              Loaded configuration:
              - MicroK8s enabled: {{ microk8s_deployment.enabled }}
              - MicroK8s channel: {{ microk8s_deployment.microk8s_channel }}
              - API Server: {{ kubernetes_deployment.api_server.host }}

    - name: Check if MicroK8s deployment is enabled
      debug:
        msg: "MicroK8s deployment is disabled in user_input.yml. Skipping all tasks."
      when: not microk8s_deployment.enabled | default(false)

    - name: Validate prerequisites
      include_tasks: "tasks/common_prerequisites.yml"
      when: 
        - microk8s_deployment.enabled | default(false)
        - not (skip_prerequisites | default(false) | bool)

    - name: Validate MicroK8s-specific prerequisites
      include_tasks: "tasks/validate_prerequisites.yml"
      when: 
        - microk8s_deployment.enabled | default(false)
        - not (skip_prerequisites | default(false) | bool)

    - name: Ensure inventory directory exists
      file:
        path: "{{ inventory_dir }}"
        state: directory
        mode: '0755'
      when: microk8s_deployment.enabled | default(false)

  tasks:
    - name: Verify MicroK8s ansible files exist
      stat:
        path: "{{ item }}"
      register: microk8s_files_check
      loop:
        - "{{ playbook_dir }}/microk8s-ansible/site.yml"
        - "{{ inventory_dir }}/microk8s/inventory.yml"
      when: microk8s_deployment.enabled | default(false)
      
    - name: Prepare MicroK8s deployment environment
      debug:
        msg: |
          ðŸ”§ Preparing MicroK8s deployment:
          - Playbook directory: {{ playbook_dir }}/microk8s-ansible
          - Inventory file: {{ inventory_dir }}/microk8s/inventory.yml
          - Working directory: {{ ansible_env.PWD }}
          
          File verification:
          {% for result in microk8s_files_check.results %}
          - {{ result.item }}: {{ 'EXISTS' if result.stat.exists else 'MISSING' }}
          {% endfor %}
      when: microk8s_deployment.enabled | default(false)
      
    - name: Fail if required files are missing
      fail:
        msg: |
          Missing required files for MicroK8s deployment:
          {% for result in microk8s_files_check.results %}
          {% if not result.stat.exists %}
          - {{ result.item }}
          {% endif %}
          {% endfor %}
      when: 
        - microk8s_deployment.enabled | default(false)
        - microk8s_files_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

    - name: Deploy MicroK8s Cluster
      shell: |
        export ANSIBLE_HOST_KEY_CHECKING=False
        export ANSIBLE_CONFIG={{ playbook_dir }}/ansible.cfg
        export ANSIBLE_COLLECTIONS_PATH={{ playbook_dir }}/collections
        cd {{ playbook_dir }}/microk8s-ansible
        ansible-playbook site.yml -i {{ inventory_dir }}/microk8s/inventory.yml -v
      register: microk8s_deployment_result
      failed_when: microk8s_deployment_result.rc != 0
      when: microk8s_deployment.enabled | default(false)
      
    - name: Show MicroK8s deployment status
      debug:
        msg: |
          ðŸš€ MicroK8s Deployment Completed Successfully!
          
          âœ… Cluster installation: {{ 'SUCCESS' if microk8s_deployment_result.rc == 0 else 'FAILED' }}
          âœ… Return code: {{ microk8s_deployment_result.rc }}
          
          ðŸ’¡ Next step: Verify cluster status with 'microk8s status'
      when: 
        - microk8s_deployment.enabled | default(false)
        - microk8s_deployment_result is defined
        
    - name: Handle MicroK8s deployment failure
      fail:
        msg: |
          âŒ MicroK8s deployment failed with return code {{ microk8s_deployment_result.rc }}
          
          Error output:
          {{ microk8s_deployment_result.stderr }}
          
          Please check the logs above for more details.
      when: 
        - microk8s_deployment.enabled | default(false)
        - microk8s_deployment_result is defined
        - microk8s_deployment_result.rc != 0

  post_tasks:
    - name: Initialize summary tracking
      include_tasks: "tasks/summary_tracker.yml"
      when: 
        - summary_enabled | default(true)
        - microk8s_deployment.enabled | default(false)

    - name: Collect and generate MicroK8s cluster summary
      include_tasks: "tasks/summary_tracker.yml"
      vars:
        generate_summary_report: false  # Don't show app summary for MicroK8s-only deployment
        generate_microk8s_summary_report: true
        should_save_summary: "{{ save_summary_to_file | default(true) }}"
      when: 
        - summary_enabled | default(true)
        - microk8s_deployment.enabled | default(false)

    - name: Display MicroK8s deployment completion message
      debug:
        msg: |
          
          ðŸŽ‰ MicroK8s cluster deployment completed!
          
          {% if save_summary_to_file | default(true) %}
          ðŸ“„ Summary report saved to: output/installation_summary_{{ ansible_date_time.epoch }}.md
          {% endif %}
          
          ðŸ” Check the cluster summary above for detailed results.
          
          ðŸ’¡ Next steps:
          â€¢ Verify cluster is ready: microk8s kubectl get nodes
          â€¢ Check system pods: microk8s kubectl get pods -n kube-system
          â€¢ Test cluster access: microk8s kubectl cluster-info
          â€¢ Get kubeconfig: microk8s config > output/kubeconfig
          â€¢ Export kubeconfig: export KUBECONFIG=$PWD/output/kubeconfig
          â€¢ All output files are saved in the ./output/ directory
          
          ðŸ“‹ To install Smart Scaler applications on this cluster:
          â€¢ Ensure global_kubeconfig in user_input.yml points to output/kubeconfig
          â€¢ Run: ansible-playbook site.yml
      when: 
        - summary_enabled | default(true)
        - microk8s_deployment.enabled | default(false)
